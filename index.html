<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>My Skin Diary — Sky Blue</title>
<meta name="theme-color" content="#7ec8ff" />
<style>
  :root{
    --bg:#f6fafe; --card:#fff; --ink:#222; --muted:#6d6d6d;
    --accent:#7ec8ff; --accent-2:#eaf6ff; --danger:#b65757; --ok:#3a8b6a;
    --shadow:0 10px 30px rgba(0,0,0,.06); --radius:16px;
  }
  @media (prefers-color-scheme: dark){
    :root{--bg:#0e1318; --card:#171a1a; --ink:#f1f1f1; --muted:#a6a6a6; --accent:#7ec8ff; --accent-2:#101820; --danger:#e07d7d; --ok:#8fd3b5; --shadow:0 8px 24px rgba(0,0,0,.35);}
  }
  html[data-theme="dark"]{--bg:#0e1318; --card:#171a1a; --ink:#f1f1f1; --muted:#a6a6a6; --accent:#7ec8ff; --accent-2:#101820; --danger:#e07d7d; --ok:#8fd3b5; --shadow:0 8px 24px rgba(0,0,0,.35);}
  *{box-sizing:border-box}
  html,body{margin:0;padding:0;background:var(--bg);color:var(--ink);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif}
  header{position:sticky;top:0;z-index:10;backdrop-filter:saturate(180%) blur(10px);background:rgba(246,250,254,.75);border-bottom:1px solid #e8eef6}
  @media (prefers-color-scheme: dark){header{background:rgba(14,19,24,.6);border-bottom:1px solid #222}}
  .wrap{max-width:1080px;margin:0 auto;padding:20px}
  .brand{display:flex;align-items:center;gap:12px;justify-content:space-between}
  .brand-left{display:flex;gap:12px;align-items:center}
  .logo{width:36px;height:36px;border-radius:10px;background:linear-gradient(160deg,#7ec8ff,#3ea8fb);box-shadow:var(--shadow)}
  h1{font-size:22px;margin:0}
  .theme-toggle{border:none;border-radius:999px;padding:10px 14px;background:var(--card);box-shadow:var(--shadow);cursor:pointer;color:var(--ink)}
  nav{margin-top:14px;display:flex;flex-wrap:wrap;gap:8px}
  nav button{border:none;border-radius:100px;padding:10px 16px;background:var(--card);box-shadow:var(--shadow);cursor:pointer;color:#333}
  @media (prefers-color-scheme: dark){nav button{color:var(--ink)}}
  nav button.active{background:var(--accent);color:white}
  main{padding:24px 0}
  .grid{display:grid;grid-template-columns:repeat(12,1fr);gap:18px}
  .card{background:var(--card);border-radius:var(--radius);box-shadow:var(--shadow);padding:18px;border:1px solid #e7f1fb20}
  .col-3{grid-column:span 3}.col-4{grid-column:span 4}.col-5{grid-column:span 5}.col-6{grid-column:span 6}.col-7{grid-column:span 7}.col-8{grid-column:span 8}.col-12{grid-column:span 12}
  @media(max-width:900px){.col-3,.col-4,.col-5,.col-6,.col-7,.col-8,.col-12{grid-column:span 12}}
  input,select,textarea{width:100%;padding:12px;border-radius:12px;border:1px solid #3a3a3a20;background:#fff;color:#222}
  @media (prefers-color-scheme: dark){input,select,textarea{background:#0f1212;color:#f1f1f1;border-color:#2b2f2f}}
  label{display:block;margin:12px 0 6px 0;color:#25364a;font-weight:600}
  @media (prefers-color-scheme: dark){label{color:#e7e7e7}}
  .row{display:flex;gap:12px;flex-wrap:wrap}.row>*{flex:1}
  .btn{display:inline-flex;align-items:center;gap:8px;border:none;border-radius:12px;padding:12px 16px;background:var(--accent);color:white;cursor:pointer}
  .btn.secondary{background:#edf6ff;color:#1c2b3a;border:1px solid #d3eaff}
  @media (prefers-color-scheme: dark){.btn.secondary{background:#1b2430;color:#e7e7e7;border-color:#25364a}}
  .btn.danger{background:var(--danger);color:white}
  .tag{display:inline-flex;align-items:center;padding:4px 10px;border-radius:999px;background:var(--accent-2);color:var(--ink);font-size:12px;margin-right:6px}
  .status-ok{background:#e6f7f0;color:var(--ok)}.status-warn{background:#fff2e0;color:#a15800}.status-avoid{background:#fdeeee;color:#b65757}
  .chips{display:flex;gap:8px;flex-wrap:wrap;margin:8px 0}.chip{border:1px solid #d3eaff;padding:6px 10px;border-radius:999px;cursor:pointer;background:transparent}
  .chip.active{background:var(--accent);color:#fff;border-color:transparent}
  .list{display:grid;gap:12px}.list .item{background:var(--card);border:1px solid #e7f1fb;border-radius:14px;padding:14px;display:flex;gap:12px;align-items:flex-start}
  .item .meta{color:var(--muted);font-size:12px}
  .pill{border-radius:999px;padding:6px 10px;background:#eef6ff;border:1px solid #d3eaff;font-size:12px}
  .photo{width:100%;border-radius:14px;object-fit:cover}
  .gallery{display:grid;grid-template-columns:repeat(4,1fr);gap:12px}
  @media(max-width:900px){.gallery{grid-template-columns:repeat(2,1fr)}}
  .mute{color:var(--muted)}.divider{height:1px;background:#e7f1fb;margin:10px 0 6px 0}.small{font-size:12px}
  .hint{background:#edf7ff;border-left:4px solid var(--accent);padding:10px;border-radius:10px}
  @media (prefers-color-scheme: dark){.hint{background:#10161d;border-left-color:var(--accent)}}
  .empty{padding:20px;border:1px dashed #d3eaff;border-radius:14px;text-align:center;color:#5b6b7a}
  .compare-wrap{position:relative;max-width:720px;border-radius:12px;overflow:hidden;box-shadow:var(--shadow)}
  .compare-wrap img{display:block;width:100%;height:auto}
  .compare-top{position:absolute;left:0;top:0;bottom:0;overflow:hidden}
  .compare-handle{position:absolute;top:50%;transform:translateY(-50%);width:2px;background:#fff;border-left:1px solid #bbb;border-right:1px solid #bbb;box-shadow:0 0 0 2px rgba(0,0,0,.08)}
  .compare-range{width:100%}
  .toast{position:fixed;left:50%;transform:translateX(-50%);bottom:24px;background:var(--card);box-shadow:var(--shadow);padding:12px 16px;border-radius:999px;display:flex;gap:10px;align-items:center;z-index:10000;border:1px solid #e7f1fb}
  .lock{position:fixed;inset:0;background:var(--bg);display:flex;align-items:center;justify-content:center;z-index:9999}
  .lock .panel{background:var(--card);padding:24px;border-radius:16px;box-shadow:var(--shadow);max-width:360px;width:92%}
</style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="brand">
      <div class="brand-left">
        <div class="logo" aria-hidden="true"></div>
        <h1>My Skin Diary</h1>
      </div>
      <button id="themeToggle" class="theme-toggle" title="Toggle theme">🌓</button>
    </div>
    <nav id="nav"></nav>
  </div>
</header>
<main class="wrap"><div id="view"></div></main>

<!-- Lock screen -->
<div id="lock" class="lock" style="display:none">
  <div class="panel">
    <h3 id="lockTitle">Unlock</h3>
    <div id="lockMsg" class="small mute" style="margin-bottom:8px"></div>
    <label>Enter passcode</label>
    <input id="lockPin" type="password" inputmode="numeric" placeholder="••••" />
    <div class="row" style="margin-top:12px">
      <button class="btn" id="unlockBtn">Unlock</button>
      <button class="btn secondary" id="unlockBio">Use Face/Touch ID</button>
    </div>
    <div class="small mute" style="margin-top:10px">Biometrics require HTTPS and a supported browser/device.</div>
  </div>
</div>

<script>
/* ===== Theme toggle ===== */
(function(){
  const key='msd.theme';
  const saved=localStorage.getItem(key);
  if(saved) document.documentElement.setAttribute('data-theme', saved);
  document.getElementById('themeToggle').onclick=()=>{
    const cur=document.documentElement.getAttribute('data-theme');
    const next=cur==='dark'? '' : 'dark';
    if(next) document.documentElement.setAttribute('data-theme', next);
    else document.documentElement.removeAttribute('data-theme');
    localStorage.setItem(key, next);
  };
})();

/* ===== Local IndexedDB ===== */
const DB='my-skin-diary', VER=1; let db;
function openDB(){return new Promise((res,rej)=>{const r=indexedDB.open(DB,VER);r.onupgradeneeded=e=>{const d=e.target.result;
  if(!d.objectStoreNames.contains('products')){const s=d.createObjectStore('products',{keyPath:'id',autoIncrement:true});s.createIndex('by_status','status');s.createIndex('by_tags','tags',{multiEntry:true});}
  if(!d.objectStoreNames.contains('elims')) d.createObjectStore('elims',{keyPath:'id',autoIncrement:true});
  if(!d.objectStoreNames.contains('photos')){const p=d.createObjectStore('photos',{keyPath:'id',autoIncrement:true});p.createIndex('by_date','dateISO');}
};r.onsuccess=()=>{db=r.result;res(db);};r.onerror=e=>{console.error("IndexedDB error:",e.target.error);rej(e.target.error);};});}
</script>

<script>
/* ===== Utils ===== */ const $=(q,el=document)=>el.querySelector(q); const h=(t,a={},...c)=>{const e=document.createElement(t);for(const[k,v]of Object.entries(a||{})){if(k==='class')e.className=v;else if(k==='style')e.style.cssText=v;else if(k.startsWith('on')&&typeof v==='function')e.addEventListener(k.slice(2),v);else if(v!=null)e.setAttribute(k,v);}for(const x of c.flat()){if(x==null)continue;e.appendChild(typeof x==='string'?document.createTextNode(x):x);}return e;} const fmtDate=i=>{try{return new Date(i).toLocaleDateString()}catch{return ''}} function downloadFile(name, content, mime='text/plain'){ const blob=new Blob([content],{type:mime}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);} /* ===== Ingredient flags (simple list) ===== */ const ING_LIST=[{k:'isopropyl myristate',t:'comedogenic'},{k:'isopropyl palmitate',t:'comedogenic'},{k:'lauric acid',t:'comedogenic'},{k:'coconut oil',t:'comedogenic'},{k:'cocoa butter',t:'comedogenic'},{k:'lanolin',t:'comedogenic'},{k:'algae extract',t:'comedogenic'},{k:'wheat germ oil',t:'comedogenic'},{k:'oleic acid',t:'comedogenic'},{k:'shea butter',t:'may clog'},{k:'ethylhexyl palmitate',t:'comedogenic'},{k:'sodium laureth sulfate',t:'irritant'},{k:'fragrance',t:'irritant'},{k:'parfum',t:'irritant'},{k:'essential oil',t:'irritant'},{k:'lemon oil',t:'photosensitizer'},{k:'lime oil',t:'photosensitizer'}]; function flagIngredients(text=''){const lower=(text||'').toLowerCase();const hits=[];for(const {k,t} of ING_LIST){if(lower.includes(k)) hits.push(`${k} (${t})`);}return hits;} function badges(p){const hits=flagIngredients(p.ingredients||'');return hits.length?h('div',{class:'small'},'⚠︎ Possible flags: '+hits.join(', ')):null} /* ===== Passcode + (optional) WebAuthn ===== */ const PASS_KEY='msd.pass.hash', PASS_SALT='msd.v1.salt'; let unlocked=false; async function sha256Hex(s){const enc=new TextEncoder().encode(s);const buf=await crypto.subtle.digest('SHA-256',enc);return[...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');} async function setPass(pin){const hash=await sha256Hex(PASS_SALT+pin);localStorage.setItem(PASS_KEY,hash);alert('Passcode set.')} async function checkPass(pin){const stored=localStorage.getItem(PASS_KEY);if(!stored)return true;const hash=await sha256Hex(PASS_SALT+pin);return stored===hash;} function hasPass(){return !!localStorage.getItem(PASS_KEY);} async function lockIfNeeded(){ if(!hasPass()){unlocked=true;return;} const lock=$('#lock'); lock.style.display='flex'; $('#unlockBtn').onclick=async()=>{const ok=await checkPass($('#lockPin').value); if(ok){unlocked=true; lock.style.display='none'; render();} else alert('Incorrect passcode.')}; $('#unlockBio').onclick=async()=>{try{ if(!window.PublicKeyCredential){alert('Biometrics not supported in this browser.');return;} if(location.protocol!=='https:'){alert('Biometric auth requires HTTPS.');return;} const challenge=crypto.getRandomValues(new Uint8Array(16)); let id=localStorage.getItem('msd.cred.id'); if(!id){const cred=await navigator.credentials.create({publicKey:{challenge,rp:{name:'My Skin Diary'},user:{id:crypto.getRandomValues(new Uint8Array(16)),name:'you@example.local',displayName:'You'},pubKeyCredParams:[{type:'public-key',alg:-7}],authenticatorSelection:{authenticatorAttachment:'platform',userVerification:'preferred'}}});id=btoa(String.fromCharCode(...new Uint8Array(cred.rawId)));localStorage.setItem('msd.cred.id',id);} await navigator.credentials.get({publicKey:{challenge,allowCredentials:[{type:'public-key',id:Uint8Array.from(atob(id),c=>c.charCodeAt(0))}],userVerification:'preferred'}}); unlocked=true; lock.style.display='none'; render(); }catch(e){alert('Biometric auth failed.')}};} /* ===== Navigation ===== */ const routes=[{id:'dashboard',label:'Dashboard'},{id:'products',label:'Products'},{id:'diet',label:'Diet & Lifestyle'},{id:'photos',label:'Photos'},{id:'compare',label:'Compare'},{id:'insights',label:'Insights'},{id:'backup',label:'Export / Import'},{id:'settings',label:'Settings'}]; let current='dashboard'; function renderNav(){const nav=$('#nav'); nav.innerHTML=''; routes.forEach(r=>{nav.appendChild(h('button',{class:r.id===current?'active':'',onclick:()=>{current=r.id;render();}},r.label));});} /* ===== Products ===== */ let tagFilter=new Set(); const parseTags=str=>(str||'').split(',').map(s=>s.trim()).filter(Boolean); function chipRow(tags){const base=['non-comedogenic','fragrance-free','oil-free','mineral spf','retinoid','bha','aha','azelaic','makeup']; const all=[...new Set(base.concat(tags||[]))].slice(0,24); const wrap=h('div',{class:'chips'}); all.forEach(t=>wrap.appendChild(h('button',{class:'chip'+(tagFilter.has(t)?' active':''),onclick:()=>{tagFilter.has(t)?tagFilter.delete(t):tagFilter.add(t);render();}},t))); if(tagFilter.size) wrap.appendChild(h('button',{class:'chip',onclick:()=>{tagFilter.clear();render();}},'Clear filters')); return wrap; } function productForm(p={}){ return h('form',{onsubmit:saveProduct}, h('div',{class:'row'},h('div',{},h('label',{},'Brand'),h('input',{name:'brand',value:p.brand||'',placeholder:'e.g., CeraVe'})),h('div',{},h('label',{},'Product name *'),h('input',{name:'name',value:p.name||'',required:true,placeholder:'e.g., SA Cleanser'}))), h('div',{class:'row'},h('div',{},h('label',{},'Category'),h('input',{name:'category',value:p.category||'',placeholder:'cleanser, moisturizer, makeup…'})),h('div',{},h('label',{},'Status'),h('select',{name:'status'},...[['using','Using'],['problematic','Potentially problematic'],['avoid','Avoid in future']].map(([v,l])=>h('option',{value:v,selected:(p.status||'using')===v},l))))), h('div',{class:'row'},h('div',{},h('label',{},'Tags (comma-separated)'),h('input',{name:'tags',value:(p.tags||[]).join(', '),placeholder:'non-comedogenic, fragrance-free'})),h('div',{},h('label',{},'Started'),h('input',{type:'date',name:'startedAt',value:(p.startedAt||'').slice(0,10)})),h('div',{},h('label',{},'Stopped'),h('input',{type:'date',name:'stoppedAt',value:(p.stoppedAt||'').slice(0,10)}))), h('label',{},'Ingredients / Actives (optional)'),h('textarea',{name:'ingredients',rows:2,placeholder:'salicylic acid, benzoyl peroxide…'},p.ingredients||''),badges(p), h('label',{},'Notes'),h('textarea',{name:'notes',rows:3,placeholder:'Observed breakouts, irritation, purging…'},p.notes||''), h('div',{class:'row',style:'margin-top:10px'},h('button',{class:'btn',type:'submit'},p.id?'Update product':'Add product'),p.id?h('button',{class:'btn danger',type:'button',onclick:()=>{if(confirm('Delete product?')) delItem('products',p.id).then(render);}},'Delete'):null), p.id?h('input',{type:'hidden',name:'id',value:p.id}):null ); } async function saveProduct(e){e.preventDefault();const fd=new FormData(e.target);const o=Object.fromEntries(fd.entries());o.tags=parseTags(o.tags||'');o.status=o.status||'using';o.startedAt=o.startedAt||null;o.stoppedAt=o.stoppedAt||null;o.ingredients=o.ingredients||'';o.notes=o.notes||''; if(o.id){o.id=Number(o.id);await put('products',o);}else await add('products',o); render();} async function viewProducts(){ const products=await all('products'); const allTags=products.flatMap(p=>p.tags||[]); const list=(tagFilter.size?products.filter(p=>(p.tags||[]).some(t=>tagFilter.has(t))):products).slice().reverse(); return h('div',{class:'grid'}, h('div',{class:'col-6'},h('div',{class:'card'},h('h3',{},'Add / Edit product'),productForm())), h('div',{class:'col-6'},h('div',{class:'card'},h('h3',{},'Your products'),chipRow(allTags), list.length?h('div',{class:'list'},...list.map(p=>h('div',{class:'item'}, h('div',{style:'flex:1'}, h('div',{},h('strong',{},p.brand?`${p.brand} — ${p.name}`:p.name)), h('div',{class:'meta'},[p.category||'·',p.ingredients?` · ${p.ingredients}`:''].join(' ')), badges(p), (p.tags&&p.tags.length)?h('div',{class:'chips',style:'margin-top:6px'},...p.tags.map(t=>h('span',{class:'chip'},t))):null, h('div',{style:'margin-top:8px'},h('span',{class:'tag '+(p.status==='using'?'status-ok':p.status==='problematic'?'status-warn':'status-avoid')},p.status))), h('div',{class:'item-right',style:'display:flex;flex-direction:column;gap:6px'},h('button',{class:'btn secondary',onclick:()=>{const form=$('form');const inputs=['brand','name','category','status','tags','startedAt','stoppedAt','ingredients','notes'];inputs.forEach(i=>form[i].value=p[i]||'');form.id.value=p.id;form.scrollIntoView({behavior:'smooth'});}},'Edit'),h('button',{class:'btn secondary',onclick:()=>{const form=$('form');form.reset();form.id.value=null;form.scrollIntoView({behavior:'smooth'});}},'New'))))):h('div',{class:'empty'},'No products yet.') ))); }
</script>

</body>
</html>

/* ===== Utils ===== */
const $=(q,el=document)=>el.querySelector(q);
const h=(t,a={},...c)=>{const e=document.createElement(t);for(const[k,v] of Object.entries(a||{})){if(k==='class')e.className=v;else if(k==='style')e.style.cssText=v;else if(k.startsWith('on')&&typeof v==='function')e.addEventListener(k.slice(2),v);else if(v!=null)e.setAttribute(k,v);}for(const x of c.flat()){if(x==null)continue;e.appendChild(typeof x==='string'?document.createTextNode(x):x);}return e;}
const fmtDate=i=>{try{return new Date(i).toLocaleDateString()}catch{return ''}}
function downloadFile(name, content, mime='text/plain'){ const blob=new Blob([content],{type:mime}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; a.click(); setTimeout(()=>URL.revokeObjectURL(url),1000);}

/* ===== Ingredient flags (simple list) ===== */
const ING_LIST=[{k:'isopropyl myristate',t:'comedogenic'},{k:'isopropyl palmitate',t:'comedogenic'},{k:'lauric acid',t:'comedogenic'},{k:'coconut oil',t:'comedogenic'},{k:'cocoa butter',t:'comedogenic'},{k:'lanolin',t:'comedogenic'},{k:'algae extract',t:'comedogenic'},{k:'wheat germ oil',t:'comedogenic'},{k:'oleic acid',t:'comedogenic'},{k:'shea butter',t:'may clog'},{k:'ethylhexyl palmitate',t:'comedogenic'},{k:'sodium laureth sulfate',t:'irritant'},{k:'fragrance',t:'irritant'},{k:'parfum',t:'irritant'},{k:'essential oil',t:'irritant'},{k:'lemon oil',t:'photosensitizer'},{k:'lime oil',t:'photosensitizer'}];
function flagIngredients(text=''){const lower=(text||'').toLowerCase();const hits=[];for(const {k,t} of ING_LIST){if(lower.includes(k)) hits.push(`${k} (${t})`);}return hits;}
function badges(p){const hits=flagIngredients(p.ingredients||'');return hits.length?h('div',{class:'small'},'⚠︎ Possible flags: '+hits.join(', ')):null}

/* ===== Passcode + (optional) WebAuthn ===== */
const PASS_KEY='msd.pass.hash', PASS_SALT='msd.v1.salt'; let unlocked=false;
async function sha256Hex(s){const enc=new TextEncoder().encode(s);const buf=await crypto.subtle.digest('SHA-256',enc);return[...new Uint8Array(buf)].map(b=>b.toString(16).padStart(2,'0')).join('');}
async function setPass(pin){const hash=await sha256Hex(PASS_SALT+pin);localStorage.setItem(PASS_KEY,hash);alert('Passcode set.')}
async function checkPass(pin){const stored=localStorage.getItem(PASS_KEY);if(!stored)return true;const hash=await sha256Hex(PASS_SALT+pin);return stored===hash;}
function hasPass(){return !!localStorage.getItem(PASS_KEY);}
async function lockIfNeeded(){
  if(!hasPass()){unlocked=true;return;}
  const lock=$('#lock'); lock.style.display='flex';
  $('#unlockBtn').onclick=async()=>{const ok=await checkPass($('#lockPin').value); if(ok){unlocked=true; lock.style.display='none'; render();} else alert('Incorrect passcode.')};
  $('#unlockBio').onclick=async()=>{try{
    if(!window.PublicKeyCredential){alert('Biometrics not supported in this browser.');return;}
    if(location.protocol!=='https:'){alert('Biometric auth requires HTTPS.');return;}
    const challenge=crypto.getRandomValues(new Uint8Array(16));
    let id=localStorage.getItem('msd.cred.id');
    if(!id){const cred=await navigator.credentials.create({publicKey:{challenge,rp:{name:'My Skin Diary'},user:{id:crypto.getRandomValues(new Uint8Array(16)),name:'you@example.local',displayName:'You'},pubKeyCredParams:[{type:'public-key',alg:-7}],authenticatorSelection:{authenticatorAttachment:'platform',userVerification:'preferred'}}});id=btoa(String.fromCharCode(...new Uint8Array(cred.rawId)));localStorage.setItem('msd.cred.id',id);}
    await navigator.credentials.get({publicKey:{challenge,allowCredentials:[{type:'public-key',id:Uint8Array.from(atob(id),c=>c.charCodeAt(0))}],userVerification:'preferred'}});
    unlocked=true; lock.style.display='none'; render();
  }catch(e){alert('Biometric auth failed.')}};}

/* ===== Navigation ===== */
const routes=[{id:'dashboard',label:'Dashboard'},{id:'products',label:'Products'},{id:'diet',label:'Diet & Lifestyle'},{id:'photos',label:'Photos'},{id:'compare',label:'Compare'},{id:'insights',label:'Insights'},{id:'backup',label:'Export / Import'},{id:'settings',label:'Settings'}];
let current='dashboard';
function renderNav(){const nav=$('#nav'); nav.innerHTML=''; routes.forEach(r=>{nav.appendChild(h('button',{class:r.id===current?'active':'',onclick:()=>{current=r.id;render();}},r.label));});}

/* ===== Products ===== */
let tagFilter=new Set();
const parseTags=str=>(str||'').split(',').map(s=>s.trim()).filter(Boolean);
function chipRow(tags){const base=['non-comedogenic','fragrance-free','oil-free','mineral spf','retinoid','bha','aha','azelaic','makeup']; const all=[...new Set(base.concat(tags||[]))].slice(0,24);
  const wrap=h('div',{class:'chips'});
  all.forEach(t=>wrap.appendChild(h('button',{class:'chip'+(tagFilter.has(t)?' active':''),onclick:()=>{tagFilter.has(t)?tagFilter.delete(t):tagFilter.add(t);render();}},t)));
  if(tagFilter.size) wrap.appendChild(h('button',{class:'chip',onclick:()=>{tagFilter.clear();render();}},'Clear filters'));
  return wrap;
}
function productForm(p={}){
  return h('form',{onsubmit:saveProduct},
    h('div',{class:'row'},h('div',{},h('label',{},'Brand'),h('input',{name:'brand',value:p.brand||'',placeholder:'e.g., CeraVe'})),h('div',{},h('label',{},'Product name *'),h('input',{name:'name',value:p.name||'',required:true,placeholder:'e.g., SA Cleanser'}))),
    h('div',{class:'row'},h('div',{},h('label',{},'Category'),h('input',{name:'category',value:p.category||'',placeholder:'cleanser, moisturizer, makeup…'})),h('div',{},h('label',{},'Status'),h('select',{name:'status'},...[['using','Using'],['problematic','Potentially problematic'],['avoid','Avoid in future']].map(([v,l])=>h('option',{value:v,selected:(p.status||'using')===v},l))))),
    h('div',{class:'row'},h('div',{},h('label',{},'Tags (comma-separated)'),h('input',{name:'tags',value:(p.tags||[]).join(', '),placeholder:'non-comedogenic, fragrance-free'})),h('div',{},h('label',{},'Started'),h('input',{type:'date',name:'startedAt',value:(p.startedAt||'').slice(0,10)})),h('div',{},h('label',{},'Stopped'),h('input',{type:'date',name:'stoppedAt',value:(p.stoppedAt||'').slice(0,10)}))),
    h('label',{},'Ingredients / Actives (optional)'),h('textarea',{name:'ingredients',rows:2,placeholder:'salicylic acid, benzoyl peroxide…'},p.ingredients||''),badges(p),
    h('label',{},'Notes'),h('textarea',{name:'notes',rows:3,placeholder:'Observed breakouts, irritation, purging…'},p.notes||'')),
    h('div',{class:'row',style:'margin-top:10px'},h('button',{class:'btn',type:'submit'},p.id?'Update product':'Add product'),p.id?h('button',{class:'btn danger',type:'button',onclick:()=>{if(confirm('Delete product?')) delItem('products',p.id).then(render);}},'Delete'):null),
    p.id?h('input',{type:'hidden',name:'id',value:p.id}):null
  );
}
async function saveProduct(e){e.preventDefault();const fd=new FormData(e.target);const o=Object.fromEntries(fd.entries());o.tags=parseTags(o.tags||'');o.status=o.status||'using';o.startedAt=o.startedAt||null;o.stoppedAt=o.stoppedAt||null;o.ingredients=o.ingredients||'';o.notes=o.notes||''; if(o.id){o.id=Number(o.id);await put('products',o);}else await add('products',o); render();}
async function viewProducts(){
  const products=await all('products'); const allTags=products.flatMap(p=>p.tags||[]); const list=(tagFilter.size?products.filter(p=>(p.tags||[]).some(t=>tagFilter.has(t))):products).slice().reverse();
  return h('div',{class:'grid'},
    h('div',{class:'col-6'},h('div',{class:'card'},h('h3',{},'Add / Edit product'),productForm())),
    h('div',{class:'col-6'},h('div',{class:'card'},h('h3',{},'Your products'),chipRow(allTags),
      list.length?h('div',{class:'list'},...list.map(p=>h('div',{class:'item'},
        h('div',{style:'flex:1'},
          h('div',{},h('strong',{},p.brand?`${p.brand} — ${p.name}`:p.name)),
          h('div',{class:'meta'},[p.category||'·',p.ingredients?` · ${p.ingredients}`:''].join(' ')),
          badges(p),
          (p.tags&&p.tags.length)?h('div',{class:'chips',style:'margin-top:6px'},...p.tags.map(t=>h('span',{class:'chip'},t))):null,
          h('div',{style:'margin-top:8px'},h('span',{class:'tag '+(p.status==='using'?'status-ok':p.status==='problematic'?'status-warn':'status-avoid')},p.status.replace('-',' '))),
          p.notes?h('div',{class:'small',style:'margin-top:8px'},p.notes):null,
          h('div',{class:'small mute'},`${p.startedAt?'Started '+fmtDate(p.startedAt):''} ${p.stoppedAt?' · Stopped '+fmtDate(p.stoppedAt):''}`)
        ),
        h('div',{},h('button',{class:'btn secondary',onclick:()=>editProduct(p.id)},'Edit'))
      ))):h('div',{class:'empty'},'No products yet.')))
  );
}
async function editProduct(id){const arr=await all('products');const p=arr.find(x=>x.id===id);const pane=$('#view .grid .card');pane.parentElement.replaceChild(h('div',{class:'card'},h('h3',{},'Add / Edit product'),productForm(p)),pane);}

/* ===== Diet & Lifestyle ===== */
function elimForm(ei={}){return h('form',{onsubmit:saveElim},
  h('div',{class:'row'},h('div',{},h('label',{},'Food / Ingredient'),h('input',{name:'food',required:true,value:ei.food||'',placeholder:'dairy, whey, soy…'})),h('div',{},h('label',{},'Status'),h('select',{name:'status'},...[['active','Eliminating'],['reintroduced','Reintroduced']].map(([v,l])=>h('option',{value:v,selected:(ei.status||'active')===v},l))))),
  h('div',{class:'row'},h('div',{},h('label',{},'Start date'),h('input',{type:'date',name:'start',value:(ei.start||'').slice(0,10)})),h('div',{},h('label',{},'End date'),h('input',{type:'date',name:'end',value:(ei.end||'').slice(0,10)}))),
  h('label',{},'Observations'),h('textarea',{name:'notes',rows:3,placeholder:'Any change in acne? energy? digestion?'},ei.notes||''),
  h('div',{class:'row',style:'margin-top:10px'},h('button',{class:'btn',type:'submit'},ei.id?'Update':'Add entry'),ei.id?h('button',{class:'btn danger',type:'button',onclick:()=>{if(confirm('Delete entry?')) delItem('elims',ei.id).then(render)}},'Delete'):null),
  ei.id?h('input',{type:'hidden',name:'id',value:ei.id}):null);}
async function saveElim(e){e.preventDefault();const fd=new FormData(e.target);const o=Object.fromEntries(fd.entries()); if(o.id){o.id=Number(o.id);await put('elims',o);}else await add('elims',o); render();}
async function viewDiet(){
  const items=await all('elims');
  const list=h('div',{class:'list'},...items.slice().reverse().map(ei=>h('div',{class:'item'},
    h('div',{style:'flex:1'},
      h('div',{},h('strong',{},ei.food),' ',h('span',{class:'pill'},ei.status)),
      h('div',{class:'small mute'},`${ei.start?fmtDate(ei.start):''} ${ei.end?'– '+fmtDate(ei.end):''}`),
      ei.notes?h('div',{class:'small',style:'margin-top:6px'},ei.notes):null
    ),
    h('div',{},h('button',{class:'btn secondary',onclick:()=>editElim(ei.id)},'Edit'))
  )));
  return h('div',{class:'grid'},
    h('div',{class:'col-6'},h('div',{class:'card'},h('h3',{},'Food elimination / reintro'),elimForm())),
    h('div',{class:'col-6'},h('div',{class:'card'},h('h3',{},'Your entries'),list))
  );
}
async function editElim(id){const arr=await all('elims');const ei=arr.find(x=>x.id===id);const pane=$('#view .grid .card');pane.parentElement.replaceChild(h('div',{class:'card'},h('h3',{},'Food elimination / reintro'),elimForm(ei)),pane);}

/* ===== Photos + Compare ===== */
function photoForm(){const today=new Date().toISOString().slice(0,10);return h('form',{onsubmit:addPhoto},
  h('div',{class:'row'},h('div',{},h('label',{},'Date'),h('input',{type:'date',name:'dateISO',value:today})),h('div',{},h('label',{},'Label'),h('input',{name:'label',placeholder:'Baseline, Week 4, Month 2…'}))),
  h('label',{},'Notes (optional)'),h('textarea',{name:'notes',rows:2,placeholder:'Routine changes, new product, breakout, cycle, stress…'}),
  h('label',{},'Photo file'),h('input',{type:'file',name:'file',accept:'image/*',required:true}),
  h('div',{class:'row',style:'margin-top:10px'},h('button',{class:'btn',type:'submit'},'Add photo')));}
async function addPhoto(e){e.preventDefault();const fd=new FormData(e.target);const f=fd.get('file');if(!f){alert('Choose a photo');return;}const dateISO=fd.get('dateISO')||new Date().toISOString();const label=fd.get('label')||'';const notes=fd.get('notes')||'';const buf=await f.arrayBuffer();const blob=new Blob([buf],{type:f.type});await add('photos',{dateISO,label,notes,blob});render();}
async function viewPhotos(){
  const photos=await all('photos');
  const list=photos.slice().reverse().map(ph=>{const url=URL.createObjectURL(ph.blob);const img=h('img',{src:url,class:'photo',alt:ph.label||'Photo'});img.onload=()=>URL.revokeObjectURL(url);
    return h('div',{class:'item'},h('div',{style:'flex:1;max-width:160px'},img),h('div',{style:'flex:2'},h('div',{},h('strong',{},ph.label||'Photo'),' ',h('span',{class:'pill'},fmtDate(ph.dateISO))),ph.notes?h('div',{class:'small',style:'margin-top:6px'},ph.notes):null),h('div',{},h('button',{class:'btn danger',onclick:()=>{if(confirm('Delete photo?')) delItem('photos',ph.id).then(render)}},'Delete')));});
  return h('div',{class:'grid'},
    h('div',{class:'col-5'},h('div',{class:'card'},h('h3',{},'Add photo'),photoForm())),
    h('div',{class:'col-7'},h('div',{class:'card'},h('h3',{},'Your photos'),list.length?h('div',{class:'list'},...list):h('div',{class:'empty'},'No photos yet.'))));
}
let pick={a:null,b:null};
async function viewCompare(){
  const photos=(await all('photos')).slice().reverse();
  const selector=h('div',{class:'list'},...photos.map(ph=>{
    const url=URL.createObjectURL(ph.blob);const img=h('img',{src:url,class:'photo',alt:ph.label||'Photo'});img.onload=()=>URL.revokeObjectURL(url);
    const checked=(pick.a&&pick.a.id===ph.id)||(pick.b&&pick.b.id===ph.id);
    return h('label',{class:'item'},h('input',{type:'checkbox',checked,onchange:e=>{if(e.target.checked){if(!pick.a)pick.a=ph;else if(!pick.b)pick.b=ph;else{e.target.checked=false;alert('Select only two photos.');}}else{if(pick.a&&pick.a.id===ph.id)pick.a=null;if(pick.b&&pick.b.id===ph.id)pick.b=null;}render();}}),h('div',{style:'flex:1;max-width:160px'},img),h('div',{style:'flex:2'},h('div',{},ph.label||'Photo',' — ',fmtDate(ph.dateISO))));
  }));
  let viewer=h('div',{class:'empty'},'Select two photos to compare.');
  if(pick.a&&pick.b){viewer=compareSlider(pick.a,pick.b);}
  return h('div',{class:'grid'},
    h('div',{class:'col-5'},h('div',{class:'card'},h('h3',{},'Choose two photos'),selector)),
    h('div',{class:'col-7'},h('div',{class:'card'},h('h3',{},'Compare'),viewer))
  );
}
function compareSlider(a,b){
  const wrap=h('div',{class:'compare-wrap'}), urlA=URL.createObjectURL(a.blob), urlB=URL.createObjectURL(b.blob);
  const bottom=h('img',{src:urlA,alt:a.label||'A'}), topWrap=h('div',{class:'compare-top',style:'width:50%'}), top=h('img',{src:urlB,alt:b.label||'B'}), handle=h('div',{class:'compare-handle',style:'left:50%;height:100%'});
  topWrap.appendChild(top); wrap.appendChild(bottom); wrap.appendChild(topWrap); wrap.appendChild(handle);
  const range=h('input',{type:'range',min:0,max:100,value:50,class:'compare-range',oninput:e=>{const pct=e.target.value; topWrap.style.width=pct+'%'; handle.style.left=pct+'%';}});
  const c=h('div',{},wrap,h('div',{style:'margin-top:8px'},range),h('div',{class:'small mute'},(a.label||'A')+' vs '+(b.label||'B'))); bottom.onload=()=>{URL.revokeObjectURL(urlA);URL.revokeObjectURL(urlB)}; return c;
}

/* ===== Insights ===== */
function monthKey(iso){const d=new Date(iso);return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,'0')}`}
async function viewInsights(){
  const products=await all('products'), elims=await all('elims'), photos=await all('photos'), months={};
  function push(m,k,v){months[m]??={start:[],stop:[],problem:[],avoid:[],elim:[],photo:[]}; months[m][k].push(v);}
  products.forEach(p=>{if(p.startedAt)push(monthKey(p.startedAt),'start',p); if(p.stoppedAt)push(monthKey(p.stoppedAt),'stop',p); if(p.status==='problematic')push(monthKey(p.startedAt||new Date().toISOString()),'problem',p); if(p.status==='avoid')push(monthKey(p.startedAt||new Date().toISOString()),'avoid',p);});
  elims.forEach(e=>push(monthKey(e.start||new Date().toISOString()),'elim',e));
  photos.forEach(ph=>push(monthKey(ph.dateISO||new Date().toISOString()),'photo',ph));
  const ordered=Object.keys(months).sort().reverse();
  const sections=ordered.map(m=>{const d=months[m]; return h('div',{class:'card'},h('h3',{},m),
    d.photo.length?h('div',{},h('strong',{},'Photos: '),String(d.photo.length)):null,
    d.start.length?h('div',{},h('strong',{},'Started: '),d.start.map(p=>p.name).join(', ')):null,
    d.stop.length?h('div',{},h('strong',{},'Stopped: '),d.stop.map(p=>p.name).join(', ')):null,
    d.problem.length?h('div',{},h('strong',{},'Potentially problematic: '),d.problem.map(p=>p.name).join(', ')):null,
    d.avoid.length?h('div',{},h('strong',{},'Avoid list additions: '),d.avoid.map(p=>p.name).join(', ')):null,
    d.elim.length?h('div',{},h('strong',{},'Diet notes: '),d.elim.map(e=>`${e.food} (${e.status})`).join(', ')):null,
    h('div',{class:'divider'}),h('div',{class:'small mute'},'Reflection prompts: What changed? Any new breakouts or irritation? Any nutrient gaps from eliminations?')
  );});
  return h('div',{class:'grid'},h('div',{class:'col-12'},sections.length?sections:h('div',{class:'empty'},'Once you add products, eliminations, and photos, summaries appear here.')));
}

/* ===== Export / Import ===== */
async function exportAll(){
  const payload={exportedAt:new Date().toISOString(),products:await all('products'),elims:await all('elims'),photos:(await all('photos')).map(p=>({id:p.id,dateISO:p.dateISO,label:p.label,notes:p.notes,blobType:p.blob.type,blobData:null}))};
  const phs=await all('photos'); for(let i=0;i<phs.length;i++){const p=phs[i]; const arr=await p.blob.arrayBuffer(); payload.photos[i].blobData=btoa(String.fromCharCode(...new Uint8Array(arr))); }
  downloadFile(`my-skin-diary-backup-${new Date().toISOString().slice(0,10)}.json`, JSON.stringify(payload), 'application/json');
}
function toCSV(rows){if(!rows.length)return'';const keys=Object.keys(rows[0]);const esc=v=>`"${String(v).replace(/"/g,'""')}"`;return keys.map(esc).join(',')+'\n'+rows.map(r=>keys.map(k=>esc(r[k]??'')).join(',')).join('\n');}
async function exportProductsCSV(){downloadFile('products.csv',toCSV(await all('products')),'text/csv')}
async function exportElimsCSV(){downloadFile('eliminations.csv',toCSV(await all('elims')),'text/csv')}
async function importAll(file){
  const text=await file.text();const data=JSON.parse(text);
  if(!confirm('Import will merge with current entries. Continue?')) return;
  if(Array.isArray(data.products)) for(const p of data.products){delete p.id; await add('products',p);}
  if(Array.isArray(data.elims)) for(const e of data.elims){delete e.id; await add('elims',e);}
  if(Array.isArray(data.photos)) for(const ph of data.photos){const bytes=Uint8Array.from(atob(ph.blobData),c=>c.charCodeAt(0));const blob=new Blob([bytes],{type:ph.blobType||'image/jpeg'});await add('photos',{dateISO:ph.dateISO,label:ph.label,notes:ph.notes,blob});}
  alert('Import complete.'); render();
}
function backupView(){
  const fileInput=h('input',{type:'file',accept:'application/json',onchange:e=>{const f=e.target.files[0];if(f)importAll(f);}});
  return h('div',{class:'grid'},h('div',{class:'col-12'},h('div',{class:'card'},h('h3',{},'Export / Import'),
    h('p',{},'Your data stays on this device. You can export a backup and import it later.'),
    h('div',{class:'row'},h('button',{class:'btn',onclick:exportAll},'Export backup (.json)'),h('button',{class:'btn secondary',onclick:exportProductsCSV},'Export products (.csv)'),h('button',{class:'btn secondary',onclick:exportElimsCSV},'Export eliminations (.csv)')),
    h('div',{style:'margin-top:14px'},fileInput),
    h('div',{class:'hint small',style:'margin-top:10px'},'Tip: Keep your backup safe. Importing merges with your current entries.'))));
}

/* ===== Settings ===== */
function settingsView(){
  const has=!!localStorage.getItem(PASS_KEY);
  const form=h('form',{onsubmit:async e=>{e.preventDefault();const pin=e.target.pin.value.trim();if(!/^\d{4,8}$/.test(pin)){alert('Use a 4–8 digit passcode.');return;}await setPass(pin);}},
    h('label',{},has?'Change passcode':'Set a passcode (4–8 digits)'),h('input',{name:'pin',type:'password',inputmode:'numeric',placeholder:'••••'}),
    h('div',{style:'margin-top:10px'},h('button',{class:'btn',type:'submit'},has?'Update passcode':'Set passcode')));
  const bio=h('button',{class:'btn secondary',onclick:()=>alert('Face/Touch ID works on HTTPS or localhost when you unlock.')},'Enable Face/Touch ID');
  return h('div',{class:'grid'},
    h('div',{class:'col-6'},h('div',{class:'card'},h('h3',{},'Security'),h('p',{class:'small mute'},'Local app lock helps protect casual access. For full security, use device lock + encryption.'),form,h('div',{style:'margin-top:10px'},bio))),
    h('div',{class:'col-6'},h('div',{class:'card'},h('h3',{},'About your data'),h('p',{},'Everything is stored locally in your browser using IndexedDB.'),h('p',{},'Use Export to create backups.'))));
}

/* ===== Dashboard ===== */
async function viewDashboard(){
  const products=await all('products'), photos=await all('photos'), elims=await all('elims');
  const active=products.filter(p=>p.status==='using').length, warn=products.filter(p=>p.status==='problematic').length, avoid=products.filter(p=>p.status==='avoid').length;
  setTimeout(()=>{const k='msd.last.toast';const last=+localStorage.getItem(k)||0;if(Date.now()-last<7*24*3600e3)return;const t=h('div',{class:'toast'},'Add a progress photo this week? ',h('button',{class:'btn secondary',onclick:()=>{document.body.removeChild(t);localStorage.setItem(k,Date.now().toString());}},'Dismiss'),h('button',{class:'btn',onclick:()=>{document.body.removeChild(t);localStorage.setItem(k,Date.now().toString());current="photos";render();}},'Open Photos'));document.body.appendChild(t);},600);
  return h('div',{class:'grid'},
    h('div',{class:'col-8'},h('div',{class:'card'},h('h2',{},'Welcome ✨'),
      h('p',{class:'mute'},'Log your routine, track reactions, and spot patterns.'),
      h('div',{class:'hint small'},'Tip: Tag products as ',h('span',{class:'tag status-warn'},'Potentially problematic'),' or ',h('span',{class:'tag status-avoid'},'Avoid in future'),' to build your personal “no” list.')),
      h('div',{class:'card',style:'margin-top:16px'},h('h3',{},'Recent Photos'),
        photos.length?h('div',{class:'gallery'},...photos.slice(-8).reverse().map(ph=>{const u=URL.createObjectURL(ph.blob);const el=h('img',{src:u,class:'photo',alt:ph.label||'Photo'});el.onload=()=>URL.revokeObjectURL(u);return el;})):h('div',{class:'empty'},'No photos yet — add one in the Photos tab.'))),
    h('div',{class:'col-4'},h('div',{class:'card'},h('h3',{},'Routine at a glance'),
      h('div',{},h('span',{class:'tag status-ok'},`Using · ${active}`)),
      h('div',{style:'margin-top:8px'},h('span',{class:'tag status-warn'},`Problematic · ${warn}`)),
      h('div',{style:'margin-top:8px'},h('span',{class:'tag status-avoid'},`Avoid · ${avoid}`)),
      h('div',{class:'divider'}),h('h4',{},'Diet eliminations'),
      elims.length?h('div',{},...elims.slice(-4).reverse().map(e=>h('div',{class:'item'},h('div',{},h('div',{class:'pill'},e.food),h('div',{class:'meta'},`${fmtDate(e.start)} ${e.end?' – '+fmtDate(e.end):''}`))))):h('div',{class:'empty'},'No eliminations yet.'))));
}

/* ===== Render ===== */
async function render(){
  await openDB();
  if(!unlocked){await lockIfNeeded(); if(!unlocked) return;}
  renderNav();
  const view=$('#view'); view.innerHTML='';
  let node;
  if(current==='dashboard') node=await viewDashboard();
  else if(current==='products') node=await viewProducts();
  else if(current==='diet') node=await viewDiet();
  else if(current==='photos') node=await viewPhotos();
  else if(current==='compare') node=await viewCompare();
  else if(current==='insights') node=await viewInsights();
  else if(current==='backup') node=backupView();
  else if(current==='settings') node=settingsView();
  view.appendChild(node);
}
document.addEventListener('DOMContentLoaded', render);
</script>
</body>

</html>

